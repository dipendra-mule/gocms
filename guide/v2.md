# CMS Backend REST API Design Document

## üéØ REST API Overview

A RESTful API that will be exposed via gRPC-Gateway. This document focuses ONLY on REST endpoints, request/response formats, and behaviors.

## üîê Authentication Endpoints

### POST /api/v1/auth/login

**Purpose**: User authentication
**Request**:

```json
{
  "email": "user@example.com",
  "password": "securepassword",
  "remember_me": false
}
```

**Response (Success - 200)**:

```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expires_in": 3600,
  "token_type": "Bearer",
  "user": {
    "id": "user-uuid",
    "email": "user@example.com",
    "name": "John Doe",
    "role": "editor",
    "permissions": ["content:read", "content:write", "media:upload"]
  }
}
```

**Response (Error - 401)**:

```json
{
  "error": "invalid_credentials",
  "message": "Invalid email or password",
  "timestamp": "2023-10-25T10:30:00Z"
}
```

### POST /api/v1/auth/refresh

**Purpose**: Refresh access token
**Request**:

```json
{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**Response**:

```json
{
  "access_token": "new-access-token",
  "expires_in": 3600,
  "token_type": "Bearer"
}
```

### POST /api/v1/auth/logout

**Purpose**: Invalidate tokens
**Request**: (empty body)
**Response**: 204 No Content

### POST /api/v1/auth/register

**Purpose**: User registration (admin only)
**Request**:

```json
{
  "email": "newuser@example.com",
  "password": "securepassword",
  "name": "Jane Smith",
  "role": "author",
  "team_id": "team-uuid-optional"
}
```

**Response**:

```json
{
  "id": "new-user-uuid",
  "email": "newuser@example.com",
  "name": "Jane Smith",
  "role": "author",
  "created_at": "2023-10-25T10:30:00Z",
  "status": "active"
}
```

## üë• User Management Endpoints

### GET /api/v1/users/me

**Purpose**: Get current user profile
**Response**:

```json
{
  "id": "user-uuid",
  "email": "user@example.com",
  "name": "John Doe",
  "role": "editor",
  "avatar_url": "https://cdn.example.com/avatars/user-uuid.jpg",
  "preferences": {
    "language": "en",
    "timezone": "UTC",
    "content_language": "en-US"
  },
  "created_at": "2023-10-25T10:30:00Z",
  "last_login": "2023-10-25T10:30:00Z"
}
```

### PUT /api/v1/users/me

**Purpose**: Update current user profile
**Request**:

```json
{
  "name": "John Updated",
  "avatar_url": "https://new-avatar.jpg",
  "preferences": {
    "language": "fr",
    "timezone": "Europe/Paris"
  }
}
```

**Response**: Updated user profile

### POST /api/v1/users/me/change-password

**Purpose**: Change own password
**Request**:

```json
{
  "current_password": "oldpassword",
  "new_password": "newsecurepassword"
}
```

**Response**: 204 No Content

### GET /api/v1/users

**Purpose**: List users (admin only)
**Query Parameters**:

- `page`: 1 (default)
- `limit`: 20 (default, max 100)
- `role`: filter by role
- `team_id`: filter by team
- `search`: search in name/email

**Response**:

```json
{
  "users": [
    {
      "id": "user-uuid",
      "email": "user@example.com",
      "name": "John Doe",
      "role": "editor",
      "status": "active",
      "last_login": "2023-10-25T10:30:00Z",
      "created_at": "2023-10-25T10:30:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 150,
    "total_pages": 8
  }
}
```

## üìù Content Management Endpoints

### GET /api/v1/contents

**Purpose**: List contents with filtering
**Query Parameters**:

- `page`: 1
- `limit`: 20
- `status`: draft|published|scheduled|archived
- `type`: page|post|article
- `author_id`: filter by author
- `locale`: en-US
- `search`: search in title/body
- `sort`: created_at|updated_at|published_at
- `order`: asc|desc
- `include_drafts`: true|false (based on permissions)

**Response**:

```json
{
  "contents": [
    {
      "id": "content-uuid",
      "slug": "my-first-post",
      "title": "My First Post",
      "excerpt": "This is a short excerpt...",
      "status": "published",
      "type": "post",
      "locale": "en-US",
      "author": {
        "id": "author-uuid",
        "name": "John Doe",
        "email": "john@example.com"
      },
      "tags": ["tech", "programming"],
      "categories": ["Technology"],
      "featured_image": {
        "id": "media-uuid",
        "url": "https://cdn.example.com/images/featured.jpg",
        "alt": "Featured image"
      },
      "published_at": "2023-10-25T10:30:00Z",
      "created_at": "2023-10-25T10:30:00Z",
      "updated_at": "2023-10-25T10:30:00Z",
      "metadata": {
        "seo_title": "SEO Optimized Title",
        "seo_description": "SEO description...",
        "read_time": 5
      }
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 150,
    "total_pages": 8
  }
}
```

### POST /api/v1/contents

**Purpose**: Create new content
**Request**:

```json
{
  "slug": "my-new-post",
  "title": "My New Post",
  "body": {
    "type": "doc",
    "content": [
      {
        "type": "paragraph",
        "content": [
          {
            "type": "text",
            "text": "This is the post content..."
          }
        ]
      }
    ]
  },
  "excerpt": "Short excerpt...",
  "status": "draft",
  "type": "post",
  "locale": "en-US",
  "tags": ["tech", "tutorial"],
  "categories": ["Programming"],
  "featured_image_id": "media-uuid-optional",
  "metadata": {
    "seo_title": "Custom SEO Title",
    "seo_description": "Custom SEO description...",
    "social_image_id": "media-uuid-optional"
  }
}
```

**Response**: Created content with full details

### GET /api/v1/contents/{id}

**Purpose**: Get specific content
**Response**:

```json
{
  "id": "content-uuid",
  "slug": "my-first-post",
  "title": "My First Post",
  "body": { ... },
  "excerpt": "Short excerpt...",
  "status": "published",
  "type": "post",
  "locale": "en-US",
  "author": {
    "id": "author-uuid",
    "name": "John Doe",
    "email": "john@example.com"
  },
  "tags": ["tech", "programming"],
  "categories": ["Technology"],
  "featured_image": { ... },
  "published_at": "2023-10-25T10:30:00Z",
  "created_at": "2023-10-25T10:30:00Z",
  "updated_at": "2023-10-25T10:30:00Z",
  "metadata": { ... },
  "version": 5,
  "revisions": [
    {
      "version": 4,
      "author": { ... },
      "created_at": "2023-10-24T15:30:00Z",
      "message": "Fixed typo in title"
    }
  ]
}
```

### PUT /api/v1/contents/{id}

**Purpose**: Update content
**Request**: Same as POST but partial updates allowed
**Headers**: `If-Match: "version-5"` (for optimistic locking)

**Response**: Updated content

### DELETE /api/v1/contents/{id}

**Purpose**: Delete content (soft delete)
**Response**: 204 No Content

### POST /api/v1/contents/{id}/publish

**Purpose**: Publish content
**Request**:

```json
{
  "publish_at": "2023-10-26T10:00:00Z", // optional for scheduling
  "message": "Ready for publication" // optional revision message
}
```

**Response**: Updated content with published status

### POST /api/v1/contents/{id}/unpublish

**Purpose**: Unpublish content
**Response**: Updated content with draft status

### GET /api/v1/contents/{id}/revisions

**Purpose**: List content revisions
**Response**:

```json
{
  "revisions": [
    {
      "version": 5,
      "author": { ... },
      "created_at": "2023-10-25T10:30:00Z",
      "message": "Final edits before publishing",
      "changes": {
        "title": true,
        "body": true
      }
    }
  ]
}
```

### POST /api/v1/contents/{id}/revert/{version}

**Purpose**: Revert to specific version
**Request**:

```json
{
  "message": "Reverting to fix broken content"
}
```

**Response**: Reverted content

## üñºÔ∏è Media Management Endpoints

### POST /api/v1/media/upload

**Purpose**: Initiate file upload
**Request**: `multipart/form-data`

- `file`: binary file
- `title`: Optional title
- `alt_text`: Optional alt text
- `caption`: Optional caption
- `folder`: Optional folder path

**Response**:

```json
{
  "id": "media-uuid",
  "filename": "image.jpg",
  "title": "Beautiful Landscape",
  "alt_text": "Mountains at sunrise",
  "caption": "Photo from my vacation",
  "mime_type": "image/jpeg",
  "size": 2048576,
  "width": 1920,
  "height": 1080,
  "url": "https://cdn.example.com/media/image.jpg",
  "thumbnail_url": "https://cdn.example.com/media/thumbnails/image.jpg",
  "variants": {
    "small": "https://cdn.example.com/media/variants/small/image.jpg",
    "medium": "https://cdn.example.com/media/variants/medium/image.jpg",
    "large": "https://cdn.example.com/media/variants/large/image.jpg"
  },
  "created_at": "2023-10-25T10:30:00Z",
  "uploaded_by": {
    "id": "user-uuid",
    "name": "John Doe"
  }
}
```

### GET /api/v1/media

**Purpose**: List media files
**Query Parameters**:

- `page`: 1
- `limit`: 20
- `mime_type`: image/jpeg, image/png, etc.
- `uploaded_by`: user ID
- `search`: search in filename/title
- `folder`: filter by folder

**Response**: Paginated list of media

### GET /api/v1/media/{id}

**Purpose**: Get media details
**Response**: Media object with full details

### PUT /api/v1/media/{id}

**Purpose**: Update media metadata
**Request**:

```json
{
  "title": "Updated Title",
  "alt_text": "Updated alt text",
  "caption": "Updated caption"
}
```

**Response**: Updated media

### DELETE /api/v1/media/{id}

**Purpose**: Delete media file
**Response**: 204 No Content

### POST /api/v1/media/folders

**Purpose**: Create media folder
**Request**:

```json
{
  "name": "blog-images",
  "parent_id": "parent-folder-uuid-optional"
}
```

**Response**: Created folder

## üîç Search Endpoints

### GET /api/v1/search/contents

**Purpose**: Search contents
**Query Parameters**:

- `q`: search query
- `page`: 1
- `limit`: 20
- `type`: content type filter
- `locale`: language filter
- `author_id`: author filter
- `tags`: tag filter
- `categories`: category filter
- `date_from`: filter from date
- `date_to`: filter to date
- `sort`: relevance|newest|oldest

**Response**:

```json
{
  "results": [
    {
      "id": "content-uuid",
      "slug": "search-result",
      "title": "Search Result Title",
      "excerpt": "This is where the search term appears...",
      "status": "published",
      "type": "post",
      "author": { ... },
      "published_at": "2023-10-25T10:30:00Z",
      "highlight": {
        "title": ["Search <em>Result</em> Title"],
        "body": ["This is where the <em>search</em> term appears..."],
        "excerpt": ["This is where the <em>search</em> term appears..."]
      },
      "score": 0.85
    }
  ],
  "pagination": { ... },
  "facets": {
    "types": [
      { "value": "post", "count": 45 },
      { "value": "page", "count": 23 }
    ],
    "authors": [
      { "value": "author-uuid", "name": "John Doe", "count": 12 }
    ],
    "tags": [
      { "value": "tech", "count": 34 },
      { "value": "tutorial", "count": 21 }
    ]
  },
  "total": 68,
  "query_time": 45
}
```

### GET /api/v1/search/media

**Purpose**: Search media files
**Query Parameters**: Similar to content search
**Response**: Paginated media results with highlights

## üìä Analytics & Dashboard Endpoints

### GET /api/v1/analytics/dashboard

**Purpose**: Get dashboard statistics
**Response**:

```json
{
  "overview": {
    "total_contents": 156,
    "published_contents": 89,
    "draft_contents": 45,
    "scheduled_contents": 22,
    "total_media": 234,
    "total_users": 15
  },
  "recent_activity": [
    {
      "type": "content_published",
      "user": { ... },
      "content": { ... },
      "timestamp": "2023-10-25T10:30:00Z"
    }
  ],
  "popular_contents": [
    {
      "content": { ... },
      "views": 1560,
      "engagement": 0.45
    }
  ]
}
```

### GET /api/v1/analytics/contents/{id}/stats

**Purpose**: Get content analytics
**Response**:

```json
{
  "content_id": "content-uuid",
  "views": 1560,
  "unique_visitors": 890,
  "average_time": 125,
  "social_shares": {
    "twitter": 45,
    "facebook": 67,
    "linkedin": 23
  },
  "conversion_rate": 0.034,
  "time_series": [
    {
      "date": "2023-10-25",
      "views": 120,
      "visitors": 89
    }
  ]
}
```

## ‚öôÔ∏è System Management Endpoints (Admin Only)

### GET /api/v1/system/health

**Purpose**: System health check
**Response**:

```json
{
  "status": "healthy",
  "timestamp": "2023-10-25T10:30:00Z",
  "services": {
    "database": {
      "status": "healthy",
      "response_time": 12
    },
    "search": {
      "status": "healthy",
      "response_time": 45
    },
    "storage": {
      "status": "healthy",
      "response_time": 23
    }
  },
  "metrics": {
    "memory_usage": 45.6,
    "cpu_usage": 23.1,
    "active_connections": 12
  }
}
```

### GET /api/v1/system/audit-logs

**Purpose**: Get audit logs
**Query Parameters**:

- `page`: 1
- `limit`: 50
- `user_id`: filter by user
- `action`: create|update|delete|publish
- `resource_type`: content|media|user
- `date_from`: filter from date
- `date_to`: filter to date

**Response**:

```json
{
  "logs": [
    {
      "id": "log-uuid",
      "user": { ... },
      "action": "content_updated",
      "resource_type": "content",
      "resource_id": "content-uuid",
      "resource_name": "My Updated Post",
      "changes": {
        "title": {
          "from": "Old Title",
          "to": "New Title"
        }
      },
      "ip_address": "192.168.1.1",
      "user_agent": "Mozilla/5.0...",
      "timestamp": "2023-10-25T10:30:00Z"
    }
  ],
  "pagination": { ... }
}
```

## üéØ Key Design Decisions

### 1. **Authentication & Security**

- JWT tokens with short expiration
- Refresh token rotation
- Role-based access control
- Optimistic locking for content updates

### 2. **Content Management**

- Rich text support via JSON content blocks
- Multi-language support
- Flexible metadata system
- Comprehensive versioning

### 3. **Media Handling**

- Direct-to-CDN uploads
- Multiple image variants
- Folder organization
- Metadata preservation

### 4. **Search & Discovery**

- Full-text search with highlighting
- Faceted filtering
- Relevance scoring
- Analytics integration

### 5. **API Conventions**

- Consistent error formatting
- Pagination for all lists
- Partial updates support
- Comprehensive filtering

This REST API design provides a solid foundation for the CMS backend while maintaining flexibility for future enhancements.

